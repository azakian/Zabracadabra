<div class="basket-page">
  <header class="page-header">
    <button
      type="button"
      class="back-button"
      (click)="goBack()"
      aria-label="Retour Ã  la page prÃ©cÃ©dente"
    >
      â† Retour
    </button>
    <h1>Mon Panier</h1>
    <p class="subtitle">{{ basketStore.totalItems() }} article(s)</p>
  </header>

  @if (basketStore.paymentResult(); as result) {
    <div class="callout" [class.success]="result.is_valid" [class.error]="!result.is_valid">
      @if (result.is_valid) {
        <span class="callout-icon">âœ“</span>
        <p>{{ result.response ?? 'Paiement effectuÃ© avec succÃ¨s !' }}</p>
      } @else {
        <span class="callout-icon">âœ—</span>
        <p>{{ result.hint ?? 'Paiement refusÃ©. Veuillez rÃ©essayer.' }}</p>
      }
      <button type="button" class="callout-close" (click)="basketStore.clearPaymentResult()">
        Ã—
      </button>
    </div>
    @if (result.is_valid) {
      <div class="reward-image-container">
        <p>ğŸ‰ <strong>Bravo, tu as fait le plus dur !</strong> ğŸ‰</p>
        <p>
          Un dernier petit effort et en combinant toutes les infos des indices prÃ©cÃ©dents (Ã 
          retrouver dans la conv ğŸ“±), tu peux me retrouver !
        </p>
        <p>
          Au pire, tu m'appelleras samedi ğŸ˜…ğŸ“
          <br />
        </p>
        <img class="reward-image" [src]="imageService.getPublicUrl()" alt="RÃ©compense" />
      </div>
    }
  }

  <section class="page-content">
    <div class="promo-hint">
      <span class="promo-tooltip" role="status">
        ğŸ’¡ Ton code promo se trouve sur l'image qui t'a permis de trouver l'adresse du site !
      </span>
    </div>

    @if (basketStore.isEmpty()) {
      <div class="empty-state" role="status">
        <p>Votre panier est vide</p>
        <a routerLink="/board-games" class="browse-link">Parcourir les jeux</a>
      </div>
    } @else {
      <ul class="basket-list" aria-label="Articles du panier">
        @for (item of basketStore.basketItems(); track item.game.id) {
          <li class="basket-item">
            <div class="item-info">
              <h2 class="item-name">{{ item.game.name }}</h2>
              <p class="item-description">{{ item.game.description }}</p>
            </div>

            <div class="item-actions">
              <div class="quantity-controls">
                <button
                  type="button"
                  class="quantity-btn"
                  (click)="basketStore.removeGameId(item.game.id)"
                  [attr.aria-label]="'RÃ©duire la quantitÃ© de ' + item.game.name"
                >
                  âˆ’
                </button>
                <span class="quantity" aria-label="QuantitÃ©">{{ item.quantity }}</span>
                <button
                  type="button"
                  class="quantity-btn"
                  (click)="basketStore.addGameId(item.game.id)"
                  [attr.aria-label]="'Augmenter la quantitÃ© de ' + item.game.name"
                >
                  +
                </button>
              </div>

              <button
                type="button"
                class="remove-btn"
                (click)="basketStore.removeItem(item.game.id)"
                [attr.aria-label]="'Supprimer ' + item.game.name + ' du panier'"
              >
                Supprimer
              </button>
            </div>
          </li>
        }
      </ul>

      <footer class="basket-footer">
        <div class="promo-section">
          <div class="promo-header">
            <label for="promo-code" class="visually-hidden">Code promo</label>
          </div>
          <div class="promo-input-group">
            <input
              id="promo-code"
              type="text"
              class="promo-input"
              placeholder="Code promo"
              [ngModel]="promoCode()"
              (ngModelChange)="promoCode.set($event)"
              aria-label="Entrer un code promo"
            />
            <button
              type="button"
              class="apply-promo-btn"
              (click)="applyPromoCode()"
              [disabled]="!promoCode()"
            >
              Appliquer
            </button>
          </div>
          <app-promo-code-status [promotion]="promotionStore.promotion()" />
        </div>

        <div class="footer-actions">
          <button type="button" class="clear-btn" (click)="basketStore.clearBasket()">
            Vider le panier
          </button>
          <button type="button" class="checkout-btn" (click)="openPaymentModal()">Commander</button>
        </div>
      </footer>
    }
  </section>
</div>

@if (showPaymentModal()) {
  <app-payment-modal (close)="closePaymentModal()" (confirmPayment)="onPaymentConfirmed($event)" />
}
